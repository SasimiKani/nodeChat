<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="utf-8">
	<title>チャット</title>
	<style>
	/* 全体のリセットと基本設定 */
	html, body {
		margin: 0;
		padding: 0;
		height: 100%;
		font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
		background-color: #f4f4f9;
	}

	/* アプリ全体を包むコンテナ */
	#container {
		margin: auto;
		/*max-width: 800px;*/
		height: 90vh;
		display: flex;
		flex-direction: column;
		background-color: #ffffff;
		border-radius: 8px;
		box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
		overflow: hidden;
	}

	/* ユーザー情報表示部分 */
	#users {
		padding: 1rem;
		background-color: #007bff;
		color: #fff;
		text-align: center;
		font-size: 1.2rem;
	}

	/* ユーザー名入力欄 */
	#userContainer {
		display: flex;
		flex-flow: row;
	}
	input[name="username"] {
		margin: 1rem;
		padding: 0.75rem;
		width: 90%;
		font-size: 1.2rem;
		border: 1px solid #ddd;
		border-radius: 4px;
		width: calc(100% - 2rem - 1.5rem);
	}
	button[name="rename"] {
		cursor: pointer;
		margin: 1rem;
		width: 10%;
		background-color: skyblue;
		border: none;
		border-radius: 1rem;
		color: white;
	}

	/* チャットメッセージ表示領域 */
	#response {
		flex-grow: 1;
		padding: 1rem;
		background-color: #fafafa;
		border-top: 1px solid #eee;
		overflow-y: auto;
		font-size: 1rem;
		line-height: 1.5;
		display: none;
	}
	#responseContainer {
		display: flex;
		flex-flow: column;
		overflow-y: scroll;
		padding: 1rem .5rem;
		height: inherit;
	}
	.responseItem {
		display: flex;
		flex-flow: row-reverse;
		align-items:  /*baseline center*/ end;
		margin: .2em;
	}
	.responseItem-he {
		flex-flow: row;
	}
	.responseItem-info {
		flex-flow: row;
    	justify-content: center;
    	font-size: 12px;
	}
	.item {
		padding: .2rem 1rem;
		border: 1px solid black;
		border-radius: 5rem;
		margin: 0 5px;
	}
	.item-time {
		border: none;
		font-size: 10px;
	}
	.item-info {
    	border: none;
	}
	.textItem {
		display: flex;
		flex-flow: column;
	}
	.item-name {
		border: none;
		font-size: 12px;
	}
	.item-text {
		background-color: green;
		color: white;
	}
	.responseItem-he .item-text {
		background-color: white;
		color: black;
	}

	/* メッセージ入力欄と送信ボタンを含むコンテナ */
	#messageContainer {
		display: flex;
		align-items: center;
		padding: 1rem;
		background-color: #fafafa;
		border-top: 1px solid #eee;
	}

	/* メッセージ入力フィールド */
	input[name="text"] {
		flex-grow: 1;
		padding: 0.75rem;
		font-size: 1rem;
		border: 1px solid #ddd;
		border-radius: 4px;
		margin-right: 1rem;
	}

	/* 送信ボタン */
	button[name="sendText"] {
		padding: 0.75rem 1rem;
		background-color: #28a745;
		border: none;
		border-radius: 4px;
		color: #fff;
		font-size: 1rem;
		cursor: pointer;
		transition: background-color 0.3s ease;
	}

	button[name="sendText"]:hover {
		background-color: #218838;
	}

	/* スクロールバーのスタイル（WebKit系ブラウザ） */
	#response::-webkit-scrollbar {
		width: 8px;
	}
	</style>

	<style>
	#response::-webkit-scrollbar-thumb {
		background-color: rgba(0, 0, 0, 0.2);
		border-radius: 4px;
	}

	.mobi-4 {
		font-size: 4rem!important;
	}
	.mobi-3 {
		font-size: 3rem!important;
	}
	.responseItem .mobi-3, .responseItem-he .mobi-3 {
		margin: 2rem 0;
	}
	.item.mobi-3 {
		padding: .5rem 3rem;
	}
	.mobi-25 {
		font-size: 2.5rem!important;
	}
	</style>
	<script src="/socket.io/socket.io.js"></script>
</head>
<body>
	<div id="container">
		<div id="users"></div>
		<div id="userContainer">
			<button name="rename" onclick="rename()">
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="30">
					<title>pencil-outline</title>
					<path d="M14.06,9L15,9.94L5.92,19H5V18.08L14.06,9M17.66,3C17.41,3 17.15,3.1 16.96,3.29L15.13,5.12L18.88,8.87L20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18.17,3.09 17.92,3 17.66,3M14.06,6.19L3,17.25V21H6.75L17.81,9.94L14.06,6.19Z" />
				</svg>
			</button>
			<input name="username" readonly>
		</div>
		<div id="messageContainer">
			<input name="text" onkeydown="(e) => onEnter(e)">
			<button name="sendText" onclick="sendText()">送信</button>
		</div>
		<!--div id="buttons">
			<button name="X" onclick="X()">Xボタン</button>
			<button name="Y" onclick="Y()">Yボタン</button>
			<button name="reset" onclick="reset()">リセット</button>
		</div-->
		<textarea id="response" spellcheck="false" readonly onload="this.value='';"></textarea>
		<div id="responseContainer"></div>
	</div>
	<script>
	var socket;
	
	document.querySelector("input[name=text]").addEventListener("keydown", (e) => {
		if (e.key === 'Enter')
			document.querySelector('button[name=sendText]').click()
	})
	
	const response = (res) => {
		const reader = res.body.getReader()
		reader.read().then(msg => {
			const decoder = new TextDecoder("utf-8")
			const decodeMsg = decoder.decode(msg.value)
		})
	}
	const postRequestBody = () => {
		return {
			method: "post",
			headers: {
				"Content-type": "application/json"
			},
			body: JSON.stringify({
				name: document.querySelector("input[name=username]").value
			})
		}
	}
	const sendText = () => {
		const reqBody = postRequestBody()
		reqBody.body = JSON.parse(reqBody.body)
		reqBody.body.text = document.querySelector("input[name=text]").value
		reqBody.body = JSON.stringify(reqBody.body)
		
		document.querySelector("input[name=text]").value = ""
		
		fetch("/sendText", reqBody)
			.then(res => {
				response(res)
			}).catch(err => {
				console.error("なんかエラー：", err)
			})
	}
	
	const rename = () => {
		if (connect(true)) {
			fetch("/rename", postRequestBody())
				.then(res => response(res))
		}
	}
	const X = () => {
		fetch("/X", postRequestBody())
			.then(res => response(res))
	}
	const Y = () => {
		fetch("/Y", postRequestBody())
			.then(res => response(res))
	}
	const reset = () => {
		fetch("/reset").then(res => response(res))
	}
	
	document.querySelector("input[name=text]").value = ""
	
	const connect = (isRename=false) => {
		if (isRename) {
			localStorage["temp"] = localStorage["username"]
			localStorage["username"] = ""
		}
		let username = localStorage["username"]
		while (!username ?? false) {
			username = prompt("ユーザー名を入力してね")
			
			if (isRename) {
				localStorage["username"] = username || localStorage["temp"]
				if (!username) return false
			}
			localStorage["username"] = username
		}
		document.querySelector("input[name=username]").value = username
		
		if (isRename) {
			socket.disconnect()
		}
		
		// socket.io を使ったクライアント側の初期化
		socket = io({
			query: {
				username: username
			}
		});

		socket.on("connect", () => {
			console.log("socket.io 接続完了");
		});

		// サーバーからの更新イベントを受信する例
		socket.on("update", (data) => {
			// ここで受信したデータを DOM に反映するなどの処理を行う
			//document.querySelector("#response").value = data
			
			const parseData = JSON.parse(data)
			
			const username = localStorage["username"]
			
			const responseContainer = document.querySelector("div#responseContainer")
			Array.from(responseContainer.children).forEach(item => {
				item.remove()
			})
			for (const row of parseData) {
				const responseItem = document.createElement("div")
				const timeDiv = document.createElement("div")
				const infoDiv = document.createElement("div")
				const textItem = document.createElement("div")
				const nameDiv = document.createElement("div")
				const textDiv = document.createElement("div")
				
				responseItem.classList.add("responseItem")
				if (row?.info) {
					responseItem.classList.add("responseItem-info")
				} else if (username !== row?.name) {
					responseItem.classList.add("responseItem-he")
				}
				
				timeDiv.classList.add("item-time")
				infoDiv.classList.add("item-info")
				nameDiv.classList.add("item-name")
				textDiv.classList.add("item-text")
				
				timeDiv.classList.add("item")
				infoDiv.classList.add("item")
				nameDiv.classList.add("item")
				textDiv.classList.add("item")
				
				if (getDeviceType() === "Mobile") {
					timeDiv.classList.add("mobi-25")
					infoDiv.classList.add("mobi-25")
					nameDiv.classList.add("mobi-25")
					textDiv.classList.add("mobi-3")
				}
				
				timeDiv.textContent = row?.time
				infoDiv.textContent = row?.info
				nameDiv.textContent = row?.name
				textDiv.textContent = row?.text
				
				if (row?.name !== username) textItem.appendChild(nameDiv)
				if (row?.text) textItem.appendChild(textDiv)
				
				if (row?.info) responseItem.appendChild(infoDiv)
				if (row?.name) responseItem.appendChild(textItem)
				if (row?.time) responseItem.appendChild(timeDiv)
				
				responseContainer.appendChild(responseItem)
			}
		});
		socket.on("getUsers", (data) => {
			// ここで受信したデータを DOM に反映するなどの処理を行う
			document.querySelector("#users").textContent = `部屋の人数：${data.length}人`
		});
		
		return true
	}
	
	connect()
	</script>
	<script>
	function getDeviceType() {
		const ua = navigator.userAgent;
		
		// モバイル端末の場合
		if (/Mobi|Android/i.test(ua)) {
			// タブレットとスマートフォンの区別をしたい場合
			if (/iPad|Tablet|Nexus 7/i.test(ua)) {
				return "Tablet";
			}
			return "Mobile";
		}
		
		// 上記に該当しなければデスクトップとみなす
		return "Desktop";
	}
	
	if (getDeviceType() === "Mobile") {
		document.querySelector('#users').classList.add("mobi-4")
		document.querySelector('input[name="username"]').classList.add("mobi-4")

		document.querySelector('#response').classList.add("mobi-25")
		document.querySelector('input[name="text"]').classList.add("mobi-25")
		document.querySelector('button[name="sendText"]').classList.add("mobi-25")
	}
	</script>
</body>
</html>